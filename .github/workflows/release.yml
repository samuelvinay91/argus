name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - name: Run release-please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          # Use PAT to allow triggering other workflows (like Claude Code Review)
          # Falls back to GITHUB_TOKEN if RELEASE_PAT is not set
          token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Log release outputs
        env:
          RELEASE_CREATED: ${{ steps.release.outputs.release_created }}
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
          VERSION: ${{ steps.release.outputs.version }}
          PR_NUMBER: ${{ steps.release.outputs.pr }}
        run: |
          echo "Release created: ${RELEASE_CREATED:-false}"
          echo "Tag: ${TAG_NAME:-none}"
          echo "Version: ${VERSION:-none}"
          echo "PR: ${PR_NUMBER:-none}"

  # Build and verify on release
  build-on-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}

      - name: Create release summary
        env:
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
          VERSION: ${{ needs.release-please.outputs.version }}
        run: |
          echo "## ðŸš€ Argus Dashboard Release ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Vercel will automatically deploy this release to production." >> $GITHUB_STEP_SUMMARY

  # Notify on release
  notify-release:
    needs: [release-please, build-on-release]
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Log release info
        env:
          VERSION: ${{ needs.release-please.outputs.version }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: |
          echo "ðŸš€ Released argus-dashboard@${VERSION}"
          echo "Tag: ${TAG_NAME}"
          echo "Vercel deployment will be triggered automatically"
